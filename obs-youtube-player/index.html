<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>OBS YouTube Player</title>
		<style>
			/* Базовые стили для полноэкранного режима */
			html,
			body {
				margin: 0;
				padding: 0;
				width: 100%;
				height: 100%;
				overflow: hidden;
				background: transparent;
			}

			#container {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				overflow: hidden;
			}

			#player {
				width: 100%;
				height: 100%;
				display: block;
			}

			/* Стили для сообщений об ошибках */
			.error-message {
				position: absolute;
				bottom: 10px;
				left: 0;
				right: 0;
				text-align: center;
				color: #ff4444;
				font-family: sans-serif;
				font-size: 14px;
				font-weight: bold;
				text-shadow: 1px 1px 2px black;
				pointer-events: none;
				display: none; /* Скрыто по умолчанию */
			}
		</style>
	</head>
	<body>
		<div id="container">
			<div class="error-message"></div>
			<div id="player"></div>
		</div>

		<script src="https://www.youtube.com/iframe_api"></script>
		<script>
			// Основной класс для управления YouTube плеером
			class YouTubePlayer {
				constructor() {
					// Инициализация основных компонентов
					this.params = this.loadParams();
					this.initDOM();
					this.validateParams();
					this.initPlayer();
					this.setupEventListeners();
				}

				// Загрузка и парсинг параметров из URL
				loadParams() {
					const params = new URL(location.href).searchParams;

					// Функция для безопасного получения параметров
					const getParam = (name, def, type) => {
						const value = params.get(name);
						if (value === null) return def;

						// Преобразование типов
						switch (type) {
							case "number":
								return Number(value);
							case "boolean":
								return value === "true";
							default:
								return value.toString();
						}
					};

					return {
						list: getParam("list", "PLGOpqYkPujc62xpFsvN3c7N7YT4M7kYGQ", "string"),
						w: getParam("w", null, "number"),
						h: getParam("h", null, "number"),
						loop: getParam("loop", true, "boolean"),
						random: getParam("random", true, "boolean"),
						quality: getParam("quality", "hd1080", "string"),
						forcequality: getParam("forcequality", true, "boolean"),
						speed: Math.max(0.25, Math.min(4, getParam("speed", 1.0, "number"))),
						volume: Math.max(0, Math.min(100, getParam("volume", 0, "number"))),
						controls: getParam("controls", false, "boolean"), // Возвращённый параметр
					};
				}

				// Инициализация DOM элементов
				initDOM() {
					this.container = document.getElementById("container");
					this.playerEl = document.getElementById("player");
					this.errorEl = document.querySelector(".error-message");

					// Установка кастомных размеров если указаны
					if (this.params.w && this.params.h) {
						this.container.style.width = `${this.params.w}px`;
						this.container.style.height = `${this.params.h}px`;
					}
				}

				// Валидация обязательных параметров
				validateParams() {
					if (!this.params.list) {
						this.showError("Playlist ID is required!", true);
						throw new Error("Missing playlist ID");
					}
				}

				// Инициализация YouTube плеера
				initPlayer() {
					this.player = new YT.Player("player", {
						width: this.params.w || this.container.offsetWidth,
						height: this.params.h || this.container.offsetHeight,
						playerVars: {
							listType: "playlist",
							list: this.params.list,
							autoplay: 1,
							controls: this.params.controls ? 1 : 0, // Управление элементами интерфейса
							modestbranding: 1,
							rel: 0,
							fs: 0,
							disablekb: 1,
							iv_load_policy: 3,
							cc_load_policy: 0,
							enablejsapi: 1,
							playsinline: 1,
							origin: location.origin,
						},
						events: {
							onReady: () => this.onPlayerReady(),
							onStateChange: (e) => this.onStateChange(e),
							onError: (e) => this.onPlayerError(e),
						},
					});
				}

				// Обработчик готовности плеера
				onPlayerReady() {
					// Применение начальных настроек
					this.player.setVolume(this.params.volume);
					this.player.setPlaybackRate(this.params.speed);
					this.player.setLoop(this.params.loop);

					// Запуск случайного воспроизведения если нужно
					if (this.params.random) {
						this.player.setShuffle(true);
						this.player.nextVideo();
					}

					// Мониторинг качества воспроизведения
					if (this.params.forcequality) {
						this.startQualityMonitor();
					}
				}

				// Мониторинг и поддержание качества видео
				startQualityMonitor() {
					this.qualityInterval = setInterval(() => {
						const currentQuality = this.player.getPlaybackQuality();
						if (currentQuality !== this.params.quality) {
							this.player.setPlaybackQuality(this.params.quality);
						}
					}, 5000);
				}

				// Обработчик изменения состояния воспроизведения
				onStateChange(event) {
					// Автоповтор плейлиста
					if (event.data === YT.PlayerState.ENDED && this.params.loop) {
						this.player.playVideo();
					}
				}

				// Показать сообщение об ошибке
				showError(message, fatal = false) {
					this.errorEl.textContent = message;
					this.errorEl.style.display = "block";
					if (fatal) throw new Error(message);
				}

				// Обработчик ошибок плеера
				onPlayerError(event) {
					const errorMap = {
						2: "Invalid parameters",
						5: "HTML5 player error",
						100: "Video not found",
						101: "Embedding disabled",
						150: "Embedding disabled",
					};
					this.showError(errorMap[event.data] || `Error code: ${event.data}`);
				}

				// Настройка обработчиков событий
				setupEventListeners() {
					// Оптимизация обработки изменения размеров
					const debounce = (fn, delay) => {
						let timeout;
						return (...args) => {
							clearTimeout(timeout);
							timeout = setTimeout(() => fn(...args), delay);
						};
					};

					// Обработчик изменения размера окна
					window.addEventListener(
						"resize",
						debounce(() => {
							if (!this.params.w && !this.params.h) {
								this.player.setSize(
									this.container.offsetWidth,
									this.container.offsetHeight
								);
							}
						}, 100)
					);
				}
			}

			// Глобальная инициализация при загрузке API
			let playerInstance;
			function onYouTubeIframeAPIReady() {
				playerInstance = new YouTubePlayer();
			}

			// Очистка ресурсов при закрытии
			window.addEventListener("beforeunload", () => {
				if (playerInstance) {
					clearInterval(playerInstance.qualityInterval);
				}
			});
		</script>
	</body>
</html>
